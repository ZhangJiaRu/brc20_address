{% extends 'base.html' %}

{% block title %}铭文详情 - {{ ticker }}{% endblock %}

{% block content %}
    <h2>{{ token.ticker }} 详情</h2>
    <section class="info-section">
        <p><strong>总供应量：</strong> {{ token.max | default('未知') }}</p>
        <p><strong>持有人数：</strong> {{ pagination.total | default('未知') }}</p>
    </section>
    <section class="holders-section">
        <h3>持有人列表</h3>
        <table class="data-table" id="holders-table">
            <thead>
                <tr>
                    <th>地址</th>
                    <th>备注</th>
                    <th>持有量</th>
                    <th>占总供应量比例</th>
                </tr>
            </thead>
            <tbody id="holders-list">
                {% for holder in holders %}
                <tr>
                    <td>
                        <a href="{{ url_for('address_detail', address=holder.address) }}">
                            {{ holder.remark | default(holder.address) }}
                        </a>
                    </td>
                    <td>{{ holder.remark | default('无') }}</td>
                    <td>{{ holder.overallBalance | float | int | default('未知') }}</td>
                    <td>{{ holder.percentage | float | round(2) | default('未知') }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="loading" style="display: none; text-align: center; padding: 20px;">
            加载中...
        </div>
    </section>
{% endblock %}

<script>
    let isLoading = false;
    let nextStart = {{ pagination.next_start | default(0) }};
    const limit = {{ pagination.limit }};
    const ticker = "{{ ticker }}";

    function loadMoreHolders() {
        if (isLoading || !nextStart) return;
        isLoading = true;
        document.getElementById('loading').style.display = 'block';

        fetch(`/token/${ticker}/holders?start=${nextStart}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const holdersList = document.getElementById('holders-list');
                    data.holders.forEach(holder => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><a href="/address/${holder.address}">${holder.remark || holder.address}</a></td>
                            <td>${holder.remark || '无'}</td>
                            <td>${Math.floor(parseFloat(holder.overallBalance) || 0)}</td>
                            <td>${(parseFloat(holder.percentage) || 0).toFixed(2)}%</td>
                        `;
                        holdersList.appendChild(row);
                    });
                    nextStart = data.pagination.next_start || null;
                    isLoading = false;
                    document.getElementById('loading').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('加载持有人失败:', error);
                isLoading = false;
                document.getElementById('loading').style.display = 'none';
            });
    }

    // 无限滚动检测
    window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
            loadMoreHolders();
        }
    });

    // 页面加载时检查是否需要加载更多数据
    document.addEventListener('DOMContentLoaded', () => {
        if (nextStart) {
            loadMoreHolders();
        }
    });
</script>